<% tape_details = Hash.new { |hash, key| hash[key] = Hash.new {|hash, key| hash[key] = Hash.new}} %>
<% @tapes.each do |tape| %>
	<% tape.consignments.order('created_at desc').each do |consignment| %>
		<% consignment.audits.order('created_at desc').each do |audit| %>
			<% audit.audited_changes.each do |key, value| %>
				<% removed = 0 %>
				<% inserted = 0 %>
				<% if key == :to_location_id %>
					<% if @locations.find_by_id(value).location.split(' - ')[1] == 'Tape Library' %>
						<% inserted = 1.0 %>
					<% end %>
				<% elsif key == :from_location_id %>
					<% if @locations.find_by_id(value).location.split(' - ')[1] == 'Tape Library' %>
						<% removed = 1.0 %>
					<% end %>
				<% end %>
				<% if !tape_details[audit.created_at.to_date][tape.reference]['inserted'] %>
					<% tape_details[audit.created_at.to_date][tape.reference]['inserted'] = 0 %>
				<% else %>
					<% tape_details[audit.created_at.to_date][tape.reference]['inserted'] += inserted %>
				<% end %>
				<% if !tape_details[audit.created_at.to_date][tape.reference]['removed'] %>
					<% tape_details[audit.created_at.to_date][tape.reference]['removed'] = 0 %>
				<% else %>
					<% tape_details[audit.created_at.to_date][tape.reference]['removed'] += removed %>
				<% end %>
				<% tape_details[audit.created_at.to_date][tape.reference]['customer_name'] = tape.customer.name %>
				<% tape_details[audit.created_at.to_date][tape.reference]['customer_id'] = tape.customer.id %>
				<% tape_details[audit.created_at.to_date][tape.reference]['total'] = tape_details[audit.created_at.to_date][tape.reference]['removed'] + tape_details[audit.created_at.to_date][tape.reference]['inserted'] %>
				<% tape_details[audit.created_at.to_date][tape.reference]['reference'] = tape.reference %>
				<% tape_details[audit.created_at.to_date][tape.reference]['hours_used'] = tape_details[audit.created_at.to_date][tape.reference]['total'] / 2 %>
			<% end %>
		<% end %>
	<% end %>
<% end %>
CustomerID, CustomerName, Tape Reference, Date, Removed, Inserted, Total, TotalRemoteHandsUsed, TotalHoursUsed
<% tape_details.each do |date_key, tape_hash| %>
	<% tape_hash.each do |tape_reference, value| %>
		<%= raw "#{tape_details[date_key][tape_reference]['customer_id']}, #{tape_details[date_key][tape_reference]['customer_name']}, #{tape_details[date_key][tape_reference]['reference']}, #{date_key}, #{tape_details[date_key][tape_reference]['removed']}, #{tape_details[date_key][tape_reference]['inserted']}, #{tape_details[date_key][tape_reference]['total']}, #{tape_details[date_key][tape_reference]['hours_used']} " %>
	<% end %>
<% end %>
